# Customer Frontend - 비즈니스 규칙

## 개요
이 문서는 customer-frontend 유닛의 비즈니스 규칙, 검증 로직, 제약사항을 정의합니다.

---

## 1. 인증 및 세션 규칙

### 1.1 자동 로그인 규칙

**규칙 ID**: AUTH-001  
**규칙**: 테이블 태블릿은 localStorage에 저장된 인증 정보로 자동 로그인해야 함

**조건**:
- `customer_auth_token`이 localStorage에 존재
- `customer_session`이 localStorage에 존재
- 세션이 유효함 (만료되지 않음)

**검증**:
```typescript
function canAutoLogin(): boolean {
  const token = localStorage.getItem('customer_auth_token');
  const sessionStr = localStorage.getItem('customer_session');
  
  if (!token || !sessionStr) return false;
  
  const session = JSON.parse(sessionStr);
  return validateSession(session);
}
```

**위반 시 동작**: 로그인 화면으로 리다이렉트

---

### 1.2 세션 유효성 규칙

**규칙 ID**: AUTH-002  
**규칙**: 세션은 만료 시각 전까지만 유효함

**조건**:
- `session.expiresAt > 현재 시각`
- `session.isActive === true`

**검증**:
```typescript
function validateSession(session: CustomerSession): boolean {
  const now = new Date();
  const expiresAt = new Date(session.expiresAt);
  
  return session.isActive && expiresAt > now;
}
```

**위반 시 동작**: 세션 자동 연장 시도

---

### 1.3 세션 자동 연장 규칙

**규칙 ID**: AUTH-003  
**규칙**: 세션 만료 시 자동으로 연장을 시도해야 함

**조건**:
- 세션이 만료됨
- 고객이 활동 중 (탐색 또는 주문 시도)

**동작**: API 호출하여 세션 연장

**실패 시 동작**: 로그아웃 및 로그인 화면으로 리다이렉트

---

### 1.4 자동 로그인 재시도 규칙

**규칙 ID**: AUTH-004  
**규칙**: 자동 로그인 실패 시 지수 백오프로 최대 3회 재시도

**재시도 간격**:
- 1차 시도: 즉시
- 2차 시도: 1초 후
- 3차 시도: 2초 후
- 4차 시도: 4초 후

**최대 재시도**: 3회

**모든 재시도 실패 시**: 로그인 화면으로 리다이렉트

---

## 2. 장바구니 규칙

### 2.1 장바구니 항목 고유성 규칙

**규칙 ID**: CART-001  
**규칙**: 동일한 메뉴는 장바구니에 하나의 항목으로만 존재하며, 수량으로 관리됨

**조건**:
- 동일한 `menuId`를 가진 항목이 이미 존재하면 수량 증가
- 존재하지 않으면 새 항목 추가

**검증**:
```typescript
function isDuplicateItem(cart: Cart, menuId: string): boolean {
  return cart.items.some(item => item.menuId === menuId);
}
```

---

### 2.2 장바구니 수량 제약 규칙

**규칙 ID**: CART-002  
**규칙**: 장바구니 항목당 수량은 1 이상 10 이하여야 함

**최소 수량**: 1  
**최대 수량**: 10

**검증**:
```typescript
function isValidQuantity(quantity: number): boolean {
  return quantity >= 1 && quantity <= 10;
}
```

**위반 시 동작**:
- 수량 < 1: 항목 제거
- 수량 > 10: 에러 메시지 표시 ("최대 수량은 10개입니다")

---

### 2.3 메뉴 가용성 규칙

**규칙 ID**: CART-003  
**규칙**: 품절된 메뉴는 장바구니에 추가할 수 없음

**조건**:
- `menuItem.isAvailable === true`

**검증**:
```typescript
function canAddToCart(menuItem: MenuItem): boolean {
  return menuItem.isAvailable;
}
```

**위반 시 동작**: 에러 메시지 표시 ("품절된 메뉴입니다")

---

### 2.4 장바구니 지속성 규칙

**규칙 ID**: CART-004  
**규칙**: 장바구니는 localStorage에 저장되며, 테이블 세션 종료 시 삭제됨

**저장 시점**:
- 항목 추가 시
- 수량 변경 시
- 항목 제거 시
- 장바구니 비우기 시

**삭제 시점**:
- 테이블 세션 종료 시
- 주문 완료 시

**저장 키**: `customer_cart`

---

### 2.5 장바구니 비어있음 검증 규칙

**규칙 ID**: CART-005  
**규칙**: 주문 제출 시 장바구니는 비어있지 않아야 함

**조건**:
- `cart.items.length > 0`

**검증**:
```typescript
function isCartEmpty(cart: Cart): boolean {
  return cart.items.length === 0;
}
```

**위반 시 동작**: 에러 메시지 표시 ("장바구니가 비어있습니다")

---

### 2.6 localStorage 용량 관리 규칙

**규칙 ID**: CART-006  
**규칙**: localStorage 용량 초과 시 가장 오래된 항목을 제거하여 공간 확보

**조건**:
- `QuotaExceededError` 발생

**동작**:
1. `addedAt` 기준으로 항목 정렬
2. 가장 오래된 항목 제거
3. 저장 재시도

---

## 3. 주문 규칙

### 3.1 주문 제출 검증 규칙

**규칙 ID**: ORDER-001  
**규칙**: 주문 제출 시 다음 조건을 모두 만족해야 함

**필수 조건**:
1. 장바구니가 비어있지 않음 (`cart.items.length > 0`)
2. 세션이 유효함 (`validateSession(session) === true`)
3. 모든 항목의 수량이 유효함 (`1 <= quantity <= 10`)

**검증**:
```typescript
function canSubmitOrder(cart: Cart, session: CustomerSession): boolean {
  if (cart.items.length === 0) return false;
  if (!validateSession(session)) return false;
  
  return cart.items.every(item => 
    item.quantity >= 1 && item.quantity <= 10
  );
}
```

**위반 시 동작**: 구체적인 에러 메시지 표시

---

### 3.2 주문 가격 사용 규칙

**규칙 ID**: ORDER-002  
**규칙**: 주문 제출 시 현재 메뉴 가격을 사용해야 함 (장바구니 추가 시점 가격 아님)

**이유**: 가격 변경에 대응

**동작**:
1. 주문 제출 전 현재 메뉴 가격 조회
2. 현재 가격으로 OrderItem 생성
3. 현재 가격으로 총액 계산

---

### 3.3 주문 완료 후 장바구니 비우기 규칙

**규칙 ID**: ORDER-003  
**규칙**: 주문이 성공적으로 생성되면 장바구니를 자동으로 비워야 함

**조건**:
- 주문 API 호출 성공 (200 OK)

**동작**:
```typescript
clearCart();
```

---

### 3.4 주문 자동 리다이렉트 규칙

**규칙 ID**: ORDER-004  
**규칙**: 주문 확인 화면에서 5초 후 자동으로 메뉴 화면으로 리다이렉트

**지연 시간**: 5초 (고정)

**리다이렉트 경로**: `/customer/menu`

---

### 3.5 주문 네트워크 에러 재시도 규칙

**규칙 ID**: ORDER-005  
**규칙**: 주문 제출 중 네트워크 에러 발생 시 지수 백오프로 자동 재시도

**재시도 간격**:
- 1차 시도: 즉시
- 2차 시도: 1초 후
- 3차 시도: 2초 후
- 4차 시도: 4초 후

**최대 재시도**: 3회

**모든 재시도 실패 시**: 에러 메시지 표시 및 수동 재시도 옵션 제공

---

## 4. 주문 내역 규칙

### 4.1 주문 내역 범위 규칙

**규칙 ID**: HISTORY-001  
**규칙**: 주문 내역은 현재 테이블 세션의 주문만 표시

**조건**:
- `order.sessionId === currentSession.sessionId`

**제외**:
- 이전 세션의 주문
- 다른 테이블의 주문

---

### 4.2 주문 상태 폴링 규칙

**규칙 ID**: HISTORY-002  
**규칙**: 주문 내역 화면에서 5분마다 주문 상태를 폴링하여 업데이트

**폴링 간격**: 5분 (300초)

**폴링 조건**:
- 주문 내역 화면이 활성화되어 있음
- 백그라운드에서는 폴링하지 않음

---

## 5. 메뉴 규칙

### 5.1 메뉴 데이터 캐싱 규칙

**규칙 ID**: MENU-001  
**규칙**: 메뉴 데이터는 React Query의 stale-while-revalidate 전략으로 캐싱

**캐싱 설정**:
- `staleTime`: 5분
- `cacheTime`: 10분
- `refetchOnWindowFocus`: true
- `refetchOnReconnect`: true

**동작**:
1. 캐시된 데이터를 즉시 표시
2. 백그라운드에서 최신 데이터 조회
3. 최신 데이터로 업데이트

---

### 5.2 메뉴 필터링 규칙

**규칙 ID**: MENU-002  
**규칙**: 메뉴는 카테고리별로 필터링 가능하며, 기본적으로 모든 메뉴 표시

**필터링 조건**:
- 카테고리 선택 시: 해당 카테고리의 메뉴만 표시
- 카테고리 미선택 시: 모든 메뉴 표시

---

### 5.3 메뉴 정렬 규칙

**규칙 ID**: MENU-003  
**규칙**: 메뉴는 `displayOrder` 오름차순으로 정렬

**정렬 기준**: `menuItem.displayOrder` (ASC)

---

### 5.4 품절 메뉴 표시 규칙

**규칙 ID**: MENU-004  
**규칙**: 품절 메뉴는 표시하되 주문 불가 상태로 표시

**표시 방식**:
- 품절 배지 표시
- "추가" 버튼 비활성화
- 시각적으로 흐리게 표시 (opacity 감소)

---

## 6. 에러 처리 규칙

### 6.1 네트워크 에러 처리 규칙

**규칙 ID**: ERROR-001  
**규칙**: 네트워크 에러 발생 시 사용자에게 명확한 메시지 표시 및 재시도 옵션 제공

**네트워크 에러 유형**:
- `ECONNABORTED`: 연결 중단
- `ENOTFOUND`: 서버를 찾을 수 없음
- `ENETUNREACH`: 네트워크 도달 불가
- `Network Error`: 일반 네트워크 에러

**동작**:
1. 에러 메시지 표시: "서버 연결에 실패했습니다"
2. 재시도 버튼 제공
3. 자동 재시도 (지수 백오프)

---

### 6.2 인증 에러 처리 규칙

**규칙 ID**: ERROR-002  
**규칙**: 인증 에러 (401 Unauthorized) 발생 시 자동 로그아웃 및 로그인 화면으로 리다이렉트

**조건**:
- HTTP 상태 코드 401

**동작**:
1. localStorage에서 인증 정보 삭제
2. 로그인 화면으로 리다이렉트
3. 에러 메시지 표시: "세션이 만료되었습니다. 다시 로그인해주세요"

---

### 6.3 서버 에러 처리 규칙

**규칙 ID**: ERROR-003  
**규칙**: 서버 에러 (5xx) 발생 시 사용자에게 에러 메시지 표시

**조건**:
- HTTP 상태 코드 500-599

**동작**:
1. 에러 메시지 표시: "서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
2. 재시도 버튼 제공

---

### 6.4 검증 에러 처리 규칙

**규칙 ID**: ERROR-004  
**규칙**: 클라이언트 검증 에러 발생 시 인라인 에러 메시지 표시

**에러 유형**:
- 빈 필드
- 유효하지 않은 수량
- 품절 메뉴 주문 시도

**동작**:
1. 해당 필드 또는 컴포넌트에 인라인 에러 메시지 표시
2. 에러 필드 강조 (빨간색 테두리)

---

## 7. UI 상태 규칙

### 7.1 로딩 상태 표시 규칙

**규칙 ID**: UI-001  
**규칙**: 비동기 작업 중 로딩 인디케이터를 표시해야 함

**로딩 표시 대상**:
- 메뉴 조회
- 주문 생성
- 주문 내역 조회
- 로그인

**로딩 인디케이터 유형**:
- 전체 화면 로딩: Spinner
- 버튼 로딩: 버튼 내 Spinner + 비활성화

---

### 7.2 토스트 알림 규칙

**규칙 ID**: UI-002  
**규칙**: 사용자 액션 결과를 토스트 알림으로 표시

**토스트 표시 대상**:
- 장바구니 추가 성공
- 주문 생성 성공
- 에러 발생

**토스트 유형**:
- `success`: 녹색, 3초 표시
- `error`: 빨간색, 5초 표시
- `info`: 파란색, 3초 표시

---

### 7.3 장바구니 배지 표시 규칙

**규칙 ID**: UI-003  
**규칙**: 장바구니 아이콘에 항목 수를 배지로 표시

**배지 표시 조건**:
- `cart.items.length > 0`

**배지 내용**:
- 총 항목 수 (수량 합계)

**배지 미표시 조건**:
- 장바구니가 비어있음

---

## 8. 동시성 규칙

### 8.1 단일 사용자 가정 규칙

**규칙 ID**: CONCURRENCY-001  
**규칙**: 테이블 태블릿은 단일 사용자가 사용한다고 가정

**이유**: 동시 수정 충돌 처리 복잡도 회피

**동작**:
- 장바구니 잠금 없음
- 마지막 쓰기 우선 (Last Write Wins)

---

## 9. 데이터 검증 규칙

### 9.1 입력 필드 검증 규칙

**규칙 ID**: VALIDATION-001  
**규칙**: 모든 입력 필드는 제출 전 검증되어야 함

**검증 대상**:
- 로그인 폼: 매장 ID, 테이블 번호, 비밀번호 (모두 필수)
- 수량 입력: 1-10 범위

**검증 시점**:
- 실시간 검증 (onChange)
- 제출 시 검증 (onSubmit)

---

### 9.2 API 응답 검증 규칙

**규칙 ID**: VALIDATION-002  
**규칙**: API 응답 데이터는 사용 전 검증되어야 함

**검증 대상**:
- 필수 필드 존재 여부
- 데이터 타입 일치
- 유효한 값 범위

**검증 실패 시**: 에러 로깅 및 기본값 사용 또는 에러 표시

---

## 10. 보안 규칙

### 10.1 인증 토큰 저장 규칙

**규칙 ID**: SECURITY-001  
**규칙**: JWT 토큰은 localStorage에 저장하며, XSS 공격에 주의

**저장 위치**: `localStorage.customer_auth_token`

**보안 고려사항**:
- HttpOnly 쿠키 사용 불가 (태블릿 환경)
- XSS 방지를 위한 입력 검증 및 출력 이스케이프

---

### 10.2 API 요청 인증 규칙

**규칙 ID**: SECURITY-002  
**규칙**: 모든 API 요청은 Authorization 헤더에 JWT 토큰을 포함해야 함

**헤더 형식**:
```
Authorization: Bearer <JWT_TOKEN>
```

**예외**: 로그인 API (`POST /customer/login`)

---

## 규칙 요약표

| 규칙 ID | 카테고리 | 규칙 요약 | 우선순위 |
|---------|----------|-----------|----------|
| AUTH-001 | 인증 | 자동 로그인 | 높음 |
| AUTH-002 | 인증 | 세션 유효성 검증 | 높음 |
| AUTH-003 | 인증 | 세션 자동 연장 | 중간 |
| AUTH-004 | 인증 | 자동 로그인 재시도 | 중간 |
| CART-001 | 장바구니 | 항목 고유성 | 높음 |
| CART-002 | 장바구니 | 수량 제약 (1-10) | 높음 |
| CART-003 | 장바구니 | 메뉴 가용성 검증 | 높음 |
| CART-004 | 장바구니 | localStorage 지속성 | 중간 |
| CART-005 | 장바구니 | 비어있음 검증 | 높음 |
| CART-006 | 장바구니 | 용량 관리 | 낮음 |
| ORDER-001 | 주문 | 주문 제출 검증 | 높음 |
| ORDER-002 | 주문 | 현재 가격 사용 | 높음 |
| ORDER-003 | 주문 | 주문 후 장바구니 비우기 | 높음 |
| ORDER-004 | 주문 | 자동 리다이렉트 (5초) | 중간 |
| ORDER-005 | 주문 | 네트워크 에러 재시도 | 중간 |
| HISTORY-001 | 주문 내역 | 현재 세션만 표시 | 높음 |
| HISTORY-002 | 주문 내역 | 5분 폴링 | 중간 |
| MENU-001 | 메뉴 | 캐싱 전략 | 중간 |
| MENU-002 | 메뉴 | 카테고리 필터링 | 중간 |
| MENU-003 | 메뉴 | displayOrder 정렬 | 낮음 |
| MENU-004 | 메뉴 | 품절 메뉴 표시 | 중간 |
| ERROR-001 | 에러 처리 | 네트워크 에러 | 높음 |
| ERROR-002 | 에러 처리 | 인증 에러 | 높음 |
| ERROR-003 | 에러 처리 | 서버 에러 | 중간 |
| ERROR-004 | 에러 처리 | 검증 에러 | 중간 |
| UI-001 | UI 상태 | 로딩 표시 | 중간 |
| UI-002 | UI 상태 | 토스트 알림 | 낮음 |
| UI-003 | UI 상태 | 장바구니 배지 | 낮음 |
| CONCURRENCY-001 | 동시성 | 단일 사용자 가정 | 낮음 |
| VALIDATION-001 | 검증 | 입력 필드 검증 | 높음 |
| VALIDATION-002 | 검증 | API 응답 검증 | 중간 |
| SECURITY-001 | 보안 | 토큰 저장 | 높음 |
| SECURITY-002 | 보안 | API 인증 | 높음 |

**총 규칙 수**: 32개
